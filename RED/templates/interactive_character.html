<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интерактивный лист персонажа - Cyberpunk RED</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Стили для интерактивного листа персонажа */
        body {
            font-family: 'Courier New', monospace;
            background-color: #0a0a0a;
            color: #00ff00;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        /* Стили для альбомной ориентации */
        @media screen {
            .character-sheet-container {
                width: 297mm;
                min-height: 210mm;
                margin: 20px auto;
                background: rgba(0, 20, 0, 0.3);
                border: 1px solid #00ff00;
                padding: 15mm;
                position: relative;
                box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            }
        }

        @media print {
            .character-sheet-container {
                width: 297mm;
                height: 210mm;
                padding: 15mm;
                margin: 0;
                box-shadow: none;
            }
            
            .no-print {
                display: none !important;
            }
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 10px;
        }

        .header h1 {
            color: #ffff00;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
            font-size: 24px;
            margin: 0;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #00ff00;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: rgba(0, 40, 0, 0.5);
            border: 1px solid #00aa00;
            border-bottom: none;
            margin-right: 5px;
            color: #00ffff;
        }

        .tab.active {
            background: rgba(0, 60, 0, 0.8);
            color: #ffff00;
            border-bottom: 1px solid #00ff00;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #00ffff;
        }

        .form-group input, 
        .form-group textarea, 
        .form-group select {
            width: 100%;
            padding: 8px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: inherit;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            background: rgba(0, 40, 0, 0.3);
            border: 1px solid #00aa00;
        }

        .stat-label {
            font-size: 14px;
            margin-bottom: 10px;
            color: #00ffff;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ffff00;
        }

        .skills-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .skills-table th {
            background: rgba(0, 100, 0, 0.5);
            color: #ffff00;
            padding: 10px;
            text-align: left;
        }

        .skills-table td {
            padding: 8px;
            border: 1px solid #00aa00;
            background: rgba(0, 20, 0, 0.3);
        }

        .lifepath-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .cyberware-list {
            margin: 20px 0;
        }

        .cyberware-item {
            display: flex;
            margin-bottom: 10px;
            gap: 10px;
        }

        .cyberware-item input {
            flex: 1;
        }

        .actions {
            text-align: center;
            margin: 30px 0;
            padding-top: 20px;
            border-top: 1px solid #00ff00;
        }

        .btn-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .dice-roll {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #ff0000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 0 15px #ff0000;
            font-weight: bold;
            font-size: 20px;
            z-index: 1000;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 15px #ff0000; }
            50% { box-shadow: 0 0 25px #ff0000, 0 0 40px #ff0000; }
            100% { box-shadow: 0 0 15px #ff0000; }
        }

        .dice-result {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ffff00;
            padding: 30px;
            border-radius: 10px;
            z-index: 1001;
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: #ffff00;
            display: none;
        }

        .dice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .lifepath-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="character-sheet-container">
            <div class="header">
                <h1>Интерактивный лист персонажа - CYBERPUNK RED</h1>
            </div>

            <div class="tabs no-print">
                <div class="tab active" data-tab="basic">Основное</div>
                <div class="tab" data-tab="stats">Характеристики</div>
                <div class="tab" data-tab="skills">Навыки</div>
                <div class="tab" data-tab="lifepath">Жизненный путь</div>
                <div class="tab" data-tab="combat">Бой</div>
                <div class="tab" data-tab="cyberware">Киберимпланты</div>
            </div>

            <form id="characterForm">
                <input type="hidden" id="characterId" name="id" value="{{ character.id if character else '' }}">
                
                <!-- Основная информация -->
                <div class="tab-content active" id="basic-tab">
                    <div class="form-group">
                        <label for="name">Имя персонажа:</label>
                        <input type="text" id="name" name="name" value="{{ character.name if character else '' }}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="role">Роль:</label>
                        <input type="text" id="role" name="role" value="{{ character.role if character else '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="ability">Осевая способность:</label>
                        <input type="text" id="ability" name="ability" value="{{ character.ability if character else '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="player_name">Имя игрока:</label>
                        <input type="text" id="player_name" name="player_name" value="{{ character.player_name if character else '' }}">
                    </div>
                </div>

                <!-- Характеристики -->
                <div class="tab-content" id="stats-tab">
                    <div class="stats-grid">
                        {% set stats = [
                            ('ИНТ', 'intelligence'),
                            ('РЕА', 'reflexes'),
                            ('ЛВК', 'luck'),
                            ('ТЕХ', 'technique'),
                            ('ХАР', 'charisma'),
                            ('ВОЛЯ', 'willpower'),
                            ('УДЧ', 'udch'),
                            ('СКО', 'sko'),
                            ('ТЕЛ', 'tel'),
                            ('ЭМП', 'empathy')
                        ] %}
                        
                        {% for label, key in stats %}
                        <div class="stat-box">
                            <div class="stat-label">{{ label }}</div>
                            <div class="stat-value">
                                <input type="number" name="stat_{{ key }}" min="0" max="10" 
                                       value="{{ character['stat_' + key] if character and 'stat_' + key in character else 0 }}"
                                       style="width: 60px; text-align: center; font-size: 24px; background: transparent; border: none; color: inherit;">
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Навыки -->
                <div class="tab-content" id="skills-tab">
                    <table class="skills-table">
                        <thead>
                            <tr>
                                <th>Навык</th>
                                <th>Характеристика</th>
                                <th>Уровень</th>
                                <th>STAT</th>
                                <th>Бонус</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set skills = [
                                ('Концентрация (ВОЛЯ)', 'concentration', 'willpower'),
                                ('Внимательность (РЕА)', 'perception', 'reflexes'),
                                ('Убеждение (ХАР)', 'persuasion', 'charisma'),
                                ('Скрытность (СКО)', 'stealth', 'sko'),
                                ('Выживание (ВОЛЯ)', 'survival', 'willpower'),
                                ('Ближний бой (ТЕЛ)', 'melee', 'tel'),
                                ('Дальний бой (ТЕЛ)', 'ranged', 'tel'),
                                ('Управление ТС (РЕА)', 'driving', 'reflexes'),
                                ('Образование (ИНТ)', 'education', 'intelligence'),
                                ('Знание улиц (ИНТ)', 'streetwise', 'intelligence'),
                                ('Социальное (ХАР)', 'social', 'charisma')
                            ] %}
                            
                            {% for label, key, stat in skills %}
                            <tr>
                                <td>{{ label }}</td>
                                <td>{{ stat[:3] }}</td>
                                <td>
                                    <input type="number" name="skill_{{ key }}" 
                                           value="{{ character['skill_' + key] if character and 'skill_' + key in character else 0 }}"
                                           style="width: 60px;">
                                </td>
                                <td>
                                    <input type="text" name="skill_{{ key }}_stat" 
                                           value="{{ character['skill_' + key + '_stat'] if character and 'skill_' + key + '_stat' in character else '' }}"
                                           style="width: 60px;">
                                </td>
                                <td>
                                    <input type="text" name="skill_{{ key }}_bonus" 
                                           value="{{ character['skill_' + key + '_bonus'] if character and 'skill_' + key + '_bonus' in character else '' }}"
                                           style="width: 60px;">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Жизненный путь -->
                <div class="tab-content" id="lifepath-tab">
                    <div class="lifepath-grid">
                        <div>
                            <div class="form-group">
                                <label for="cultural_heritage">Культурное наследие:</label>
                                <input type="text" id="cultural_heritage" name="cultural_heritage" 
                                       value="{{ character.cultural_heritage if character else '' }}">
                            </div>
                            
                            <div class="form-group">
                                <label for="clothing_style">Стиль одежды:</label>
                                <input type="text" id="clothing_style" name="clothing_style" 
                                       value="{{ character.clothing_style if character else '' }}">
                            </div>
                            
                            <div class="form-group">
                                <label for="values">Что ты ценишь больше всего?:</label>
                                <input type="text" id="values" name="values" 
                                       value="{{ character.values if character else '' }}">
                            </div>
                            
                            <div class="form-group">
                                <label for="closest_person">Самый близкий человек:</label>
                                <input type="text" id="closest_person" name="closest_person" 
                                       value="{{ character.closest_person if character else '' }}">
                            </div>
                            
                            <div class="form-group">
                                <label for="family_history">История семьи:</label>
                                <textarea id="family_history" name="family_history" rows="3">{{ character.family_history if character else '' }}</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="family_status">Семейное положение:</label>
                                <input type="text" id="family_status" name="family_status" 
                                       value="{{ character.family_status if character else '' }}">
                            </div>
                            
                            <div class="form-group">
                                <label for="friends">Друзья:</label>
                                <textarea id="friends" name="friends" rows="3">{{ character.friends if character else '' }}</textarea>
                            </div>
                        </div>
                        
                        <div>
                            <div class="form-group">
                                <label for="personality">Личность:</label>
                                <input type="text" id="personality" name="personality" 
                                       value="{{ character.personality if character else '' }}">
                            </div>
                            
                            <div class="form-group">
                                <label for="hairstyle">Прическа:</label>
                                <input type="text" id="hairstyle" name="hairstyle" 
                                       value="{{ character.hairstyle if character else '' }}">
                            </div>
                            
                            <div class="form-group">
                                <label for="attitude_toward_people">Отношение к людям?:</label>
                                <input type="text" id="attitude_toward_people" name="attitude_toward_people" 
                                       value="{{ character.attitude_toward_people if character else '' }}">
                            </div>
                            
                            <div class="form-group">
                                <label for="most_valuable">Самое ценное, чем ты обладаешь:</label>
                                <input type="text" id="most_valuable" name="most_valuable" 
                                       value="{{ character.most_valuable if character else '' }}">
                            </div>
                            
                            <div class="form-group">
                                <label for="childhood_environment">Среда, в которой прошло детство:</label>
                                <textarea id="childhood_environment" name="childhood_environment" rows="3">{{ character.childhood_environment if character else '' }}</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="life_goals">Жизненные цели:</label>
                                <textarea id="life_goals" name="life_goals" rows="3">{{ character.life_goals if character else '' }}</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="tragic_love">Трагическая любовь:</label>
                                <textarea id="tragic_love" name="tragic_love" rows="3">{{ character.tragic_love if character else '' }}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="enemies">Враги:</label>
                        <textarea id="enemies" name="enemies" rows="3">{{ character.enemies if character else '' }}</textarea>
                    </div>
                </div>

                <!-- Боевые характеристики -->
                <div class="tab-content" id="combat-tab">
                    <div class="form-group">
                        <label for="primary_weapon">Основное оружие:</label>
                        <input type="text" id="primary_weapon" name="primary_weapon" 
                               value="{{ character.primary_weapon if character else '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="secondary_weapon">Доп. оружие:</label>
                        <input type="text" id="secondary_weapon" name="secondary_weapon" 
                               value="{{ character.secondary_weapon if character else '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="other_weapons">Другое оружие:</label>
                        <input type="text" id="other_weapons" name="other_weapons" 
                               value="{{ character.other_weapons if character else '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="head_armor_sp">Защита головы (SP):</label>
                        <input type="text" id="head_armor_sp" name="head_armor_sp" 
                               value="{{ character.head_armor_sp if character else '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="body_armor_sp">Защита туловища (SP):</label>
                        <input type="text" id="body_armor_sp" name="body_armor_sp" 
                               value="{{ character.body_armor_sp if character else '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="legs_armor_sp">Защита ног (SP):</label>
                        <input type="text" id="legs_armor_sp" name="legs_armor_sp" 
                               value="{{ character.legs_armor_sp if character else '' }}">
                    </div>
                </div>

                <!-- Киберимпланты -->
                <div class="tab-content" id="cyberware-tab">
                    <div class="cyberware-list">
                        {% for i in range(1, 9) %}
                        <div class="cyberware-item">
                            <input type="text" name="cyberware_{{ i }}_type" 
                                   placeholder="Тип киберимпланта" 
                                   value="{{ character['cyberware_' + i|string + '_type'] if character and 'cyberware_' + i|string + '_type' in character else '' }}">
                            <input type="text" name="cyberware_{{ i }}_desc" 
                                   placeholder="Описание / Характеристики" 
                                   value="{{ character['cyberware_' + i|string + '_desc'] if character and 'cyberware_' + i|string + '_desc' in character else '' }}">
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="actions no-print">
                    <div class="btn-group">
                        <button type="button" class="btn" onclick="saveCharacter()">Сохранить персонажа</button>
                        <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">Главная</button>
                        {% if character %}
                        <button type="button" class="btn" onclick="generatePDF({{ character.id }})">Скачать PDF</button>
                        <button type="button" class="btn" onclick="deleteCharacter({{ character.id }})">Удалить</button>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Кнопка броска кубиков -->
    <div class="dice-roll no-print" onclick="rollDice()">1d10</div>
    
    <!-- Результат броска кубиков -->
    <div class="dice-overlay no-print" id="diceOverlay" onclick="closeDiceResult()"></div>
    <div class="dice-result no-print" id="diceResult"></div>

    <script>
        // Переключение вкладок
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Убрать активный класс у всех вкладок и контента
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Добавить активный класс к выбранной вкладке
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });

        // Сохранение персонажа
        async function saveCharacter() {
            const form = document.getElementById('characterForm');
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            try {
                const response = await fetch('/api/character', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Персонаж сохранен!');
                    if (!data.id) {
                        window.location.href = `/character?id=${result.id}`;
                    }
                } else {
                    alert('Ошибка сохранения: ' + result.error);
                }
            } catch (error) {
                alert('Ошибка сети: ' + error);
            }
        }

        // Генерация PDF
        function generatePDF(characterId) {
            window.open(`/character/${characterId}/pdf`, '_blank');
        }

        // Удаление персонажа
        async function deleteCharacter(characterId) {
            if (confirm('Удалить этого персонажа?')) {
                try {
                    const response = await fetch(`/api/delete/character/${characterId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Персонаж удален');
                        window.location.href = '/';
                    } else {
                        alert('Ошибка удаления: ' + result.error);
                    }
                } catch (error) {
                    alert('Ошибка сети: ' + error);
                }
            }
        }

        // Бросок кубиков
        function rollDice() {
            const result = Math.floor(Math.random() * 10) + 1;
            document.getElementById('diceResult').textContent = result;
            document.getElementById('diceResult').style.display = 'block';
            document.getElementById('diceOverlay').style.display = 'block';
        }

        // Закрыть результат броска
        function closeDiceResult() {
            document.getElementById('diceResult').style.display = 'none';
            document.getElementById('diceOverlay').style.display = 'none';
        }
    </script>
</body>
</html>